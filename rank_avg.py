import pandas as pd
from glob import glob
from tqdm import tqdm
from multiprocessing import Pool

# TARGET_DIR = './share/nn_invalid/'
# TARGET_DIR = './share/lgbm0_005/'
# TARGET_DIR = './share/lgbm2_005/'
TARGET_DIR = './share/nn_valid/'

paths = glob(TARGET_DIR + '*')

res = pd.DataFrame()
for i, path in tqdm(list(enumerate(paths))):
    out = pd.read_csv(path)
    if i == 0:
        res['MachineIdentifier'] = out.MachineIdentifier
        res['HasDetections'] = out.HasDetections.rank() / out.shape[0]
        continue
    res['HasDetections'] = res['HasDetections'] + out['HasDetections'].rank() / out.shape[0]
res['HasDetections'] = res['HasDetections'] / len(paths)

# FILENAME = 'nn_seed_avg_pub.csv.gz'
# FILENAME = 'lgbm0_seed_avg_pub.csv.gz'
# FILENAME = 'lgbm2_seed_avg_pub.csv.gz'
FILENAME = 'nn_valid_seed_avg_pub.csv.gz'
res.to_csv('./submissions/' + FILENAME, index=False, compression='gzip')
