import gc

import numpy as np
import pandas as pd
from tqdm import tqdm

from ..utils.general_utils import load_configs


def _get_percent_nunique(grouped_df, percent=0.7):
    cumsumed = grouped_df.AvSigVersion.value_counts().cumsum()
    res_nunique = cumsumed[cumsumed < cumsumed.iloc[-1] * percent].size
    return res_nunique


def e021_version_type_to_AvSigVersion_nunique_features(df):
    '''
    AvSigVersion's nunique becomes the encoded value.
    It's cutted off using 70% to remove time series effect.

    '''
    if 'MachineIdentifier' not in df.columns or 'AvSigVersion' not in df.columns:
        raise Exception(
            'you have to include MachineIdentifier and AvSigVersion at least.')

    res_df = pd.DataFrame()
    res_df['MachineIdentifier'] = df['MachineIdentifier']

    target_cols = [
        col for col in df.columns if col not in [
            'MachineIdentifier',
            'AvSigVersion']]
    for col in tqdm(target_cols):
        _res_df = df[[col, 'AvSigVersion']].groupby(
            col).apply(_get_percent_nunique).reset_index()
        _res_df.columns = [col, col + '_70per_nuniq_AvSigVersion']
        res_df[col] = df[col]
        res_df = res_df.merge(_res_df, on=col, how='left')
        res_df = res_df.drop(col, axis=1)

    # drop non useful cols
    # add exp id to the col
    res_df.columns = ['e021_' + col if col !=
                      'MachineIdentifier' else col for col in res_df.columns]
    return res_df
