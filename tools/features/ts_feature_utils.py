import os

import numpy as np
import pandas as pd

from ..utils.feature_tools import load_features
from ..utils.general_utils import dec_timer, load_configs, sel_log
from .e013_local_DateAS_features_1 import e013_local_DateAS_features_1
from .e015_local_DateAS_features_2 import e015_local_DateAS_features_2
from .e020_local_DateAS_features_3 import e020_local_DateAS_features_3
from .e021_version_type_to_AvSigVersion_nunique_features import \
    e021_version_type_to_AvSigVersion_nunique_features
from .e022_DateAS_rolling import e022_DateAS_rolling


def _ts_features(df, exp_ids):
    _features = []
    if 'e013' in exp_ids:
        _features.append(e013_local_DateAS_features_1(df))
    if 'e015' in exp_ids:
        _features.append(e015_local_DateAS_features_2(df))
    if 'e020' in exp_ids:
        _features.append(e020_local_DateAS_features_3(df))
    if 'e021' in exp_ids:
        _features.append(
            e021_version_type_to_AvSigVersion_nunique_features(df))
    if 'e022' in exp_ids:
        _features.append(e022_DateAS_rolling(df))
    features = pd.concat(_features, axis=1)
    return features


@dec_timer
def _load_ts_features(
        exp_ids, trn_tst_df, trn_df, tst_df, logger):
    target_ids = [
        'e013',
        'e015',
        'e020',
        'e021',
        'e022',
    ]
    if len(set(target_ids) & set(exp_ids)) < 1:
        sel_log(f'''
                ======== {__name__} ========
                Stop feature making because even 1 element in exp_ids
                    {exp_ids}
                does not in target_ids
                    {target_ids}''', logger)
        return None, None, None

    sel_log(f'creating trn_tst_df ...', None)
    configs = load_configs('./feature_config.yml', logger)
    features = []
    for exp_id in exp_ids:
        features += configs[exp_id]
    features = sorted(np.unique(features).tolist())
    trn_tst_df = load_features(
        features,
        './inputs/features/',
        os.cpu_count(),
        logger)

    return trn_tst_df, None, None
