import gc

import numpy as np
import pandas as pd
from tqdm import tqdm

from ..utils.general_utils import load_configs


def e029_AvSigVersion_abstver_binary_aggregate(df):
    if 'MachineIdentifier' not in df.columns or 'AvSigVersion' not in df.columns:
        raise Exception(
            'you have to include MachineIdentifier and AvSigVersion at least.')

    res_df = pd.DataFrame()
    res_df['MachineIdentifier'] = df['MachineIdentifier']
    df['AvSigVersionABST'] = df['AvSigVersion'].apply(
        lambda x: '.'.join(x.split('.')[:2]))
    res_df['AvSigVersionABST'] = df['AvSigVersionABST']

    # remove few samples
    ver_cnts = res_df.groupby('AvSigVersionABST').MachineIdentifier.count()
    valid_versions = ver_cnts[ver_cnts > 1000].index

    target_cols = [col for col in df.columns if col not in res_df.columns.tolist()]
    # count at first
    piv_df = df.pivot_table(
        values=target_cols,
        index='AvSigVersionABST',
        aggfunc='mean')
    piv_df = piv_df.add_suffix('_mean')
    piv_df = piv_df.loc[valid_versions]
    res_df = res_df.merge(piv_df, on='AvSigVersionABST', how='left')

    # drop non useful cols
    # add exp id to the col
    res_df = res_df.drop('AvSigVersionABST', axis=1)
    res_df.columns = ['e029_' + col if col !=
                      'MachineIdentifier' else col for col in res_df.columns]
    return res_df
